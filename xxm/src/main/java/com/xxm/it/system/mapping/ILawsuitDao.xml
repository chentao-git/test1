<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xxm.it.system.dao.ILawsuitDao">
	
	<sql id="select_filed_sql">
		SELECT 
			filed_id as filedId,
			loan_number as loanNumber,
			customer_name as customerName,
			license_number as lawsuitVehicle,
			card_number as cardNumber,
			applied_amount as appliedAmount,
			apply_date as applyDate,
			info_status as infoStatus
	    FROM 
	    		xxm_filed_info_t t
	    WHERE 1 = 1 
	</sql>
	
	<sql id="filed_select_condition">
		<!-- 诉讼贷款客户名称 -->
		<if test="customerName != null and customerName != ''">
    		AND t.customer_name like concat('%',#{customerName,jdbcType=VARCHAR},'%')
    	</if>
    	<!-- 诉讼贷款编号 -->
    	<if test="loanNumber != null and loanNumber != ''">
    		AND t.loan_number = #{loanNumber,jdbcType=VARCHAR} 
    	</if>
    	<!-- 诉讼申请状态 -->
    	<if test="infoStatus != null and infoStatus !=''">
	    	AND t.info_status = #{infoStatus,jdbcType=VARCHAR}
	  	 </if>
    	<!-- 诉讼时间 -->
    	<if test="startDate != null and startDate != ''">
    		AND t.apply_date >= #{startDate,jdbcType=VARCHAR}	
    	</if>
    	<!-- 诉讼时间 -->
    	<if test="endDate != null and endDate != ''">
    		AND t.apply_date  <![CDATA[ <= ]]> #{endDate,jdbcType=VARCHAR}	
    	</if>
    	
	</sql>
	<!-- 集合列表查询-->
	<select id="findSellList" resultType="com.xxm.it.system.vo.FiledVO" parameterType="com.xxm.it.system.vo.FiledVO">
		<include refid="select_filed_sql"></include>
		<include refid="filed_select_condition"></include>
		order by t.create_date desc limit #{offset,jdbcType=VARCHAR},#{limit,jdbcType=VARCHAR}
	</select> 
	
	<!-- 添加诉讼信息 -->
	<insert id="saveApplyInfo" parameterType="com.xxm.it.system.vo.FiledVO" >
		INSERT INTO xxm_filed_info_t(
			loan_number,
			customer_name,
			license_number,
			card_number,
			applied_amount,
			applied_date,
			info_status,
			apply_name,
			apply_date,
			apply_remark,
			create_date
		)values(
			#{loanNumber,jdbcType=VARCHAR},
			#{customerName,jdbcType=VARCHAR},
			#{lawsuitVehicle,jdbcType=VARCHAR},
			#{cardNumber,jdbcType=VARCHAR},
			#{appliedAmount,jdbcType=VARCHAR},
			now(),
			1,
			#{applyName,jdbcType=VARCHAR},
			#{applyDate,jdbcType=VARCHAR},
			#{applyRemark,jdbcType=VARCHAR},
			now()
		);
	</insert>
	
	<!-- 根据贷款编号查询客户信息 -->
	<select id="loanNumberQuery" resultType="com.xxm.it.system.vo.FiledVO" parameterType="com.xxm.it.system.vo.FiledVO">		
		SELECT 
			t.apply_Info_Id as applyInfoId,
			t.loan_Contract_No as loanNumber,
			t1.plate_Number as lawsuitVehicle,
			t2.base_Customer_Name as customerName,
			t2.cert_No as cardNumber,
			t2.mobile_No as customerPhone,
			t3.apply_amt as appliedAmount,
			t3.appl_nosInst as periods
		FROM 
			xxm_apply_info_t t,
			xxm_lease_info_t t1,
			xxm_customer_t t2,
			ms_citem_credit t3
		WHERE 
			t.apply_Info_Id = t1.apply_Info_Id AND
			t.apply_Customer_Id = t2.customer_Id AND
			t.citem_credit_id = t3.citem_credit_id AND
			t.loan_Contract_No =#{loanNumber,jdbcType=VARCHAR};
	</select>
	
	<!-- 查询诉讼审核客户信息 -->
	<select id="auditInfoQuery" parameterType="com.xxm.it.system.vo.FiledVO" resultType="com.xxm.it.system.vo.FiledVO">
		SELECT
			t.filed_id as filedId,
			t.loan_number as loanNumber,
			t.customer_name as customerName,
			t.card_number as cardNumber,
			t1.mobile_No as customerPhone,
			t.applied_amount as appliedAmount,
			t3.appl_nosInst as periods,
			t4.frame_Number as frameNumber,
			t4.engine_Number as engineNumber,
			t4.plate_Number as lawsuitVehicle,
			t5.mortgageInfo_id as mortgageInfoId,
			t.applied_date as appliedDate,
			t.apply_name as applyName,
			t.apply_date as applyDate,
			t.apply_remark as applyRemark
		FROM
			xxm_filed_info_t t,
			xxm_customer_t t1,
			xxm_apply_info_t t2,
			ms_citem_credit t3,
			xxm_lease_info_t t4,
			ms_mortgageinfo t5
		WHERE
			 t1.customer_Id = t2.apply_Customer_Id and
			 t2.citem_credit_id = t3.citem_credit_id and
			 t2.citem_car_id = t4.lease_info_id and
			 t2.apply_Info_Id = t5.apply_Info_Id and 
			 t.filed_id = #{filedId,jdbcType=VARCHAR} GROUP BY filed_id; 
			
	</select>
	<!-- 诉讼申请贷款总和查询-->
	<select id="findFiledListCount" resultType="java.lang.Integer" parameterType="com.xxm.it.system.vo.FiledVO">
		 SELECT count(filed_id) FROM xxm_filed_info_t t where 1 = 1 
		 <include refid="filed_select_condition"></include>
	</select> 
	<!-- 查询跟进信息 -->
	<select id="auditParticularsQuery" resultType="String" parameterType="com.xxm.it.system.vo.FiledVO">
		select t.content from xxm_filed_follow_t t where t.filed_id = #{filedId,jdbcType=VARCHAR};
	</select>
	<!-- 查询根进详情信息 -->
	<select id="particularsfinedInfo" resultType="com.xxm.it.system.vo.FiledVO" parameterType="com.xxm.it.system.vo.FiledVO">
		SELECT
			t.filed_id as filedId,
			t.customer_name as customerName,
			t.loan_number as loanNumber,
			t.apply_name as applyName,
			t.apply_date as applyDate,
			t.apply_remark as applyRemark,
			t.audit_name as auditName,
			t.audit_date as auditDate,
			t.audit_remark as auditRemark,
			t.register_remark as registerRemark,
			t.register_status as registerStatus
		FROM
			xxm_filed_info_t t
		WHERE
			t.filed_id = #{filedId,jdbcType=VARCHAR};
	</select>
	
	<!-- 添加诉讼跟踪信息 -->
	<insert id="addTrackingInfo" parameterType="com.xxm.it.system.vo.RemarkVO">
		insert into xxm_filed_follow_t(
			filed_id,
			content
		)values(
			#{filed,jdbcType=VARCHAR},
			#{content,jdbcType=VARCHAR}
		);
	</insert>
	
	<!-- 保存审核信息 -->
	<update id="saveAuditInfo" parameterType="com.xxm.it.system.vo.FiledVO">
		UPDATE xxm_filed_info_t t
			SET 
				t.audit_name = #{auditName,jdbcType=VARCHAR},
		 		t.audit_date = #{auditDate,jdbcType=VARCHAR},
		 		t.audit_remark = #{auditRemark,jdbcType=VARCHAR},
		 		t.info_status = 2
		WHERE
			t.filed_id = #{filedId,jdbcType=VARCHAR};
	</update>
	
	<!-- 处理登记信息保存 -->
	<update id="addRegisterInfo" parameterType="com.xxm.it.system.vo.FiledVO">
		UPDATE xxm_filed_info_t t
			SET 
				t.register_remark = #{auditRemark,jdbcType=VARCHAR},
		 		t.register_status = #{infoStatus,jdbcType=VARCHAR},
		 		t.info_status = 3
		WHERE
			t.filed_id = #{filedId,jdbcType=VARCHAR};
	</update>
</mapper>